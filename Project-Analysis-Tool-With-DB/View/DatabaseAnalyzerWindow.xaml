<Window x:Class="SpAnalyzerTool.View.DatabaseAnalyzerWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:SpAnalyzerTool.ViewModel"
        xmlns:converters="clr-namespace:SpAnalyzerTool.Converter"
        mc:Ignorable="d"
        Title="تحليل قاعدة بيانات"
        Height="700"
        Width="1000"
        Loaded="Window_Loaded"
        WindowStartupLocation="CenterScreen"
        WindowStyle="SingleBorderWindow"
        ResizeMode="CanMinimize"
        Background="WhiteSmoke" x:Name="MyWindow">

    <Window.Resources>
        <converters:LocationDisplayConverter x:Key="LocationDisplayConverter"/>
    </Window.Resources>
    
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- إعدادات الاتصال -->
        <GroupBox Header="🔗 إعدادات الاتصال" Grid.Row="0" Margin="0,0,0,5">
            <StackPanel Orientation="Vertical" Margin="10">

                <!-- اختيار السيرفر مع زر التحميل والتحديث -->
                <TextBlock Text="اسم السيرفر" Style="{StaticResource HeaderTextBlock}"/>
                <DockPanel LastChildFill="False">
                    <ComboBox x:Name="cmbServers"
                              Style="{StaticResource StyledComboBox}"
                              Width="400"
                              IsEditable="True"
                              IsTextSearchEnabled="True"
                              Loaded="cmbServers_Loaded"/>

                    <Button   x:Name="btnLoadDataBases" 
                              Content="🔄 جلب قواعد البيانات"
                              Style="{StaticResource PrimaryButton}"
                              Width="170"
                              Click="LoadDatabasesForSelectedServer"/>

                    <Button x:Name="btnRefreshServers"
                            Content="🔄 تحديث السيرفرات"
                            Style="{StaticResource PrimaryButton}"
                            Width="140"
                            Margin="10,0,0,0"
                            Click="ReloadServers_Click"/>
                </DockPanel>

                <ProgressBar x:Name="prgLoading"
                             Height="10"
                             IsIndeterminate="True"
                             Visibility="Collapsed"
                             Margin="10,10,0,0"/>


                <!-- قواعد البيانات -->
                <TextBlock Text="قواعد البيانات المتوفرة" Style="{StaticResource HeaderTextBlock}" />
                <ComboBox x:Name="cmbDatabases"
                          Style="{StaticResource StyledComboBox}"
                          Width="400"
                          IsEditable="True"
                          HorizontalAlignment="Left"
                          IsTextSearchEnabled="True" SelectionChanged="cmbDatabases_SelectionChanged"/>

                <!-- حجم النسخة -->
                <TextBlock x:Name="txtBackupSize"
                           Margin="2,0,0,0"
                           Foreground="DarkGreen"
                           FontWeight="Bold"/>
            </StackPanel>
        </GroupBox>



        <!-- مجلد المشروع -->
        <GroupBox Header="📁 مجلد المشروع" Grid.Row="1" Margin="0,0,0,10">
            <StackPanel Orientation="Vertical" Margin="10">
                <TextBlock Text="مسار المشروع:" Style="{StaticResource HeaderTextBlock}" />
                <DockPanel>
                    <TextBox  Text="{Binding ProjectPath , Mode=TwoWay}" Width="600" Height="30" Margin="0,0,5,0"/>
                    <Button Content="📁 استعراض" Width="190" Margin="0,0,130,0" Style="{StaticResource PrimaryButton}" Click="BrowseProject_Click"/>
                </DockPanel>
                <TextBlock x:Name="txtProjectSize" Foreground="DarkGreen" FontWeight="Bold" Margin="2,0,0,0" />
            </StackPanel>
        </GroupBox>


        <!-- أزرار الإجراءات -->
        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Grid.Row="2" Margin="0,0,0,5">
            <Button Content="🔍 تحليل المشروع" Style="{StaticResource PrimaryButton}" Width="150"  Click="Analyze_Click"/>
            <Button Content="🗑️ حذف الإجراءات غير المستخدمة" Style="{StaticResource PrimaryButton}" Width="250" Click="DeleteUnusedProcedures_Click"/>
            <Button Content="➕ إضافة اجراء" Style="{StaticResource PrimaryButton}" Width="250" Command="{Binding AddNewProceduerEditorCommand}" />
        </StackPanel>

        <TextBlock x:Name="txtStatus"
   Grid.Row="2"
   Margin="10,50,0,0"
   Foreground="DarkOrange"
   FontWeight="Bold"
    Visibility="Collapsed"
   Text="🔄 جاري التحليل، يرجى الانتظار..." />


        <Grid  Grid.Row="3" Margin="0,0,0,10" x:Name="grdUC" Visibility="Collapsed" >
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="auto"/>
                <RowDefinition Height="auto"/>
            </Grid.RowDefinitions>

            
            <DataGrid  x:Name="dgv"    
                       Style="{StaticResource StyledDataGrid}"
                ItemsSource="{Binding ObProject}"
                SelectedItem="{Binding SelectedProcedure, Mode=TwoWay}"
                AutoGenerateColumns="False"
                HeadersVisibility="Column"
                CanUserAddRows="False"
                CanUserDeleteRows="False"
                FontFamily="Consolas"
                FontSize="14"
                Margin="0,10,0,10"
                IsReadOnly="True">
                <DataGrid.Columns>
                    
               

                <!-- اسم البروسيجر -->
                <DataGridTextColumn Header="اسم البروسيجر" Binding="{Binding Procedure}" Width="200"/>

                <!-- العدد -->
                <DataGridTextColumn Header="العدد" Binding="{Binding Count}" Width="50"/>

                <!-- الحالة -->
                <DataGridTextColumn Header="الحالة" Binding="{Binding Status}" Width="130">
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Status}" Value="❌ غير مستخدم">
                                    <Setter Property="Foreground" Value="Red"/>
                                    <Setter Property="FontWeight" Value="Bold"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>

                <!-- ✅ المواقع -->
                    <DataGridTemplateColumn Header="المواقع" Width="400">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <ItemsControl ItemsSource="{Binding LocationPaths}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock 
                            Text="{Binding Path=., Converter={StaticResource LocationDisplayConverter}}" 
                            Foreground="Blue"
                            TextDecorations="Underline"
                            Cursor="Hand"
                            Margin="0,0,5,0">
                                                <TextBlock.InputBindings>
                                                    <MouseBinding Gesture="LeftClick"
                                    Command="{Binding DataContext.OpenLocationInEditorCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                    CommandParameter="{Binding}" />
                                                </TextBlock.InputBindings>
                                            </TextBlock>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>


                    <!-- ✅ تحديد للحذف + تعديل -->
                <DataGridTemplateColumn Width="230">
                        <DataGridTemplateColumn.Header>
                            <CheckBox Content="تحديد الكل" Foreground="White"  ToolTip="تحديد الكل" Style="{StaticResource DataGridCheckBoxStyle}"
                                      Click="CheckBox_Click"
         />
                        </DataGridTemplateColumn.Header>
                        <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center"
                                        Margin="5">
                                    <CheckBox IsChecked="{Binding IsSelectedForDelete, Mode=TwoWay}" Margin="0,0,15,0" Style="{StaticResource DataGridCheckBoxStyle}"  /> 
                                <Button Content="📝" Style="{StaticResource DataGridButtonStyle}" 
                            ToolTip="تعديل الإجراء"
                            
                            Command="{Binding DataContext.EditProcedureEditorCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                            CommandParameter="{Binding}" />
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                </DataGrid.Columns>
            </DataGrid>

            <!-- StackPanel للملخص -->
            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,5,10,5">
                <TextBlock Text="{Binding TotalCount}" Margin="0,0,0,0" FontWeight="Bold"/>
                <TextBlock Text=" : العدد الإجمالي" Margin="5,0,0,0"/>

                <TextBlock Text="{Binding UsedCount}" Margin="15,0,0,0" Foreground="Green" FontWeight="Bold"/>
                <TextBlock Text=" : المستخدم" Margin="5,0,0,0"/>

                <TextBlock Text="{Binding  UnusedCount}" Margin="15,0,0,0" Foreground="Red" FontWeight="Bold"/>
                <TextBlock Text=" : غير مستخدم"/>
            </StackPanel>

            <!-- زر التصدير -->
            <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,10,0,0">
                <Button Content="📄 تصدير النتائج" Width="400"
          Style="{StaticResource PrimaryButton}"
          Command="{Binding ExportResultsCommand}"/>
            </StackPanel>


        </Grid>



        <!-- الطبقة العائمة التي تظهر فوق المحتوى -->
        <Grid x:Name="OverlayContainer"
          Background="#80000000"
          Visibility="Collapsed"
          HorizontalAlignment="Stretch"
          VerticalAlignment="Stretch"
          Panel.ZIndex="999">
        </Grid>


    </Grid>
    
    

</Window>
